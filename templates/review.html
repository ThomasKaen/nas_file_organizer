<!-- templates/review.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Review · NAS Organizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; vertical-align: top; }
    .muted { color: #666; font-size: 12px; }
    .conf { font-variant-numeric: tabular-nums; }
    .path { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; color:#444; }
    .actions { white-space: nowrap; }
    .btn { padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa; cursor: pointer; }
    .btn.primary { background: #0ea5e9; color: white; border-color: #0ea5e9; }
    select, input[type=text] { padding: 6px 8px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Review</h1>
      <div class="flex items-center gap-2">
        <!-- Optional: quick create form in header -->
        <form method="post" action="/review/labels/new" class="flex items-center gap-2">
          <input type="text" name="name" placeholder="New label…" class="px-2 py-1 border rounded">
          <button class="px-3 py-1 rounded bg-slate-200 hover:bg-slate-300 text-sm" type="submit">Create</button>
        </form>
        <a href="/" class="px-3 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-sm">← Back</a>
      </div>
    </div>

    <p class="text-slate-500 text-sm mb-3">Archive root: {{ archive_root }}</p>
{% if metrics %}
<div class="bg-white rounded border border-slate-200 p-3 mb-3">
  <div class="flex flex-wrap gap-4 items-baseline text-sm">
    <div><span class="font-semibold">Model:</span> {{ metrics.version }}</div>
    {% if metrics.created_at %}<div><span class="font-semibold">Trained:</span> {{ metrics.created_at }}</div>{% endif %}
    {% if metrics.samples is not none %}<div><span class="font-semibold">Samples:</span> {{ metrics.samples }}</div>{% endif %}
    <div><span class="font-semibold">Accuracy:</span>
      {% if metrics.accuracy is not none %}{{ '%.3f'|format(metrics.accuracy) }}{% else %}n/a{% endif %}
    </div>
    <div><span class="font-semibold">Macro-F1:</span>
      {% if metrics.macro_f1 is not none %}{{ '%.3f'|format(metrics.macro_f1) }}{% else %}n/a{% endif %}
    </div>
    {% if metrics.notes %}<div><span class="font-semibold">Notes:</span> {{ metrics.notes }}</div>{% endif %}
  </div>

  {% if class_counts and class_counts|length > 0 %}
  <div class="mt-2 text-sm">
    <span class="font-semibold">Class counts:</span>
    <ul class="list-disc ml-5 mt-1">
      {% for label, n in class_counts[:8] %}
      <li>{{ label }} — {{ n }}</li>
      {% endfor %}
      {% if class_counts|length > 8 %}
      <li>… and {{ class_counts|length - 8 }} more</li>
      {% endif %}
    </ul>
  </div>
  {% endif %}
</div>
{% endif %}
    <table>
      <thead>
        <tr>
          <th style="width:2%"><input type="checkbox" id="checkAll"/></th>
          <th>File</th>
          <th>Prediction</th>
          <th>Choose label</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>
            <!-- Checkbox belongs to the bulk form via form="bulkForm" -->
            <input type="checkbox" name="file_hash" value="{{ r['file_hash'] }}" class="rowCheck" form="bulkForm"/>
          </td>

          <td style="width:43%">
            <div class="path">{{ r["path"] }}</div>
            <div class="muted">{{ (r["text"] or "")[:160] }}</div>
          </td>

          <td style="width:20%">
            <div><strong>{{ r["predicted_label"] or "—" }}</strong></div>
            <div class="muted conf">conf: {{ '%.2f' % (r["confidence"] or 0) }}</div>
          </td>

          <td style="width:20%">
            <!-- Per-row SAVE -->
            <form class="inline" method="post" action="/review/submit">
              <input type="hidden" name="file_hash" value="{{ r['file_hash'] }}"/>
              <input type="hidden" name="predicted_label" value="{{ r['predicted_label'] or '' }}"/>
              <select name="corrected_label">
                {% if r["predicted_label"] %}
                  <option value="{{ r['predicted_label'] }}">✔ {{ r['predicted_label'] }} (pred)</option>
                {% endif %}
                {% for lbl in labels %}
                  {% if lbl != r["predicted_label"] %}
                    <option value="{{ lbl }}">{{ lbl }}</option>
                  {% endif %}
                {% endfor %}
                <option value="_Review">_Review</option>
                <option disabled>──────────────</option>
                <option value="__new__">➕ New label…</option>
              </select>
              <label class="muted"><input type="checkbox" name="move_file" value="1" checked/> move file</label>
              <button class="btn primary" type="submit">Save</button>
            </form>
          </td>

          <td class="actions" style="width:15%">
            {% if r["predicted_label"] %}
            <!-- Per-row APPROVE -->
            <form class="inline" method="post" action="/review/submit">
              <input type="hidden" name="file_hash" value="{{ r['file_hash'] }}"/>
              <input type="hidden" name="predicted_label" value="{{ r['predicted_label'] or '' }}"/>
              <input type="hidden" name="corrected_label" value="{{ r['predicted_label'] }}"/>
              <input type="hidden" name="move_file" value="1"/>
              <button class="btn" type="submit">Approve</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Bulk form (separate, not wrapping the table) -->
    <form method="post" action="/review/bulk" id="bulkForm" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
      <span class="muted">Bulk:</span>
      <select name="corrected_label">
        {% for lbl in labels %}
          <option value="{{ lbl }}">{{ lbl }}</option>
        {% endfor %}
        <option value="_Review">_Review</option>
        <option disabled>──────────────</option>
        <option value="__new__">➕ New label…</option>
      </select>
      <label class="muted"><input type="checkbox" name="move_file" value="1" checked/> move files</label>
      <button class="btn primary" type="submit">Assign to selected</button>
      <span id="selCount" class="muted" style="margin-left:8px;">0 selected</span>
    </form>

    <div class="top">
  <h2>Review queue</h2>
  <div style="display:flex; gap:10px; align-items:center">
    <form method="post" action="/review/retrain">
      <button class="primary" type="submit">Retrain model</button>
    </form>
    <a href="/settings/schedule">
      <button type="button">⚙️ Retrain schedule</button>
    </a>
  </div>
</div>

    <div class="row muted" style="margin-top:10px;">
      Showing {{ rows|length }} items ·
      <a href="/review?only_pending=1">Pending</a> |
      <a href="/review?only_pending=0">All</a>
    </div>
  </div>
  {% if request.query_params.get('retrained') %}
  <div class="fixed bottom-4 right-4 rounded bg-emerald-500 text-white px-3 py-2 shadow">
    Model retrained successfully.
  </div>
  <script>setTimeout(()=>{ document.querySelector('.fixed.bottom-4.right-4')?.remove(); }, 3000);</script>
{% endif %}

  <script>
    // select all / selection count
    const checkAll = document.getElementById('checkAll');
    const rowChecks = () => Array.from(document.querySelectorAll('.rowCheck'));
    const selCount = document.getElementById('selCount');
    const update = () => { selCount.textContent = (rowChecks().filter(c=>c.checked).length) + " selected"; };
    checkAll?.addEventListener('change', e => { rowChecks().forEach(cb => cb.checked = e.target.checked); update(); });
    rowChecks().forEach(cb => cb.addEventListener('change', update));
    update();

    // “New label…” in dropdowns → POST /review/labels/new then reload
    function hookNewLabel(select) {
      select.addEventListener('change', e => {
        if (e.target.value === "__new__") {
          const name = prompt("Enter new label name:");
          e.target.value = ""; // reset selection
          if (name && name.trim()) {
            const form = document.createElement("form");
            form.method = "post";
            form.action = "/review/labels/new";   // NOTE: prefixed path
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "name";
            input.value = name.trim().replace(/\s+/g, "_");
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
          }
        }
      });
    }
    document.querySelectorAll('select[name="corrected_label"]').forEach(hookNewLabel);
  </script>
</body>
</html>
